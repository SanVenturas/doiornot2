<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上不上AI评分系统</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="stats-counter" id="stats-counter">
        分析次数: <span id="analysis-count">0</span>
    </div>
    
    <div class="container">
        <header>
            <h1>上不上AI评分系统</h1>
            <p class="subtitle">上传图片，让AI来评判它的可操性</p>
        </header>
        
        <div class="disclaimer" id="disclaimer">
            <button class="close-btn" id="close-disclaimer">×</button>
            <p>⚠️ <strong>免责声明：</strong> 就图一乐，AI就看外形瞎评，甭当真！别拿自己照片试水，怕被喷就闪，审美这玩意儿因人而异！</p>
        </div>

        <div class="announcement" id="announcement">
            <button class="close-btn" id="close-announcement">×</button>
            <h3>📢 系统公告</h3>
            <p>如果显示错误，很可能是因为AI模型认为图片内容不适宜评价（例如真人裸露）。请尝试二次元或SFW图片。禁止上传违禁内容。</p>
        </div>

        <div class="ai-type-selector">
            <p>选择AI分析模式：</p>
            <div class="ai-type-options">
                <label class="ai-type-option">
                    <input type="radio" name="ai-type" value="brief" checked>
                    <span class="ai-type-name">简短模式</span>
                    <span class="ai-type-desc">短平快，1-2句，够味</span>
                </label>
                <label class="ai-type-option">
                    <input type="radio" name="ai-type" value="descriptive">
                    <span class="ai-type-name">详细模式</span>
                    <span class="ai-type-desc">细说3+句，够劲</span>
                </label>
                <label class="ai-type-option">
                    <input type="radio" name="ai-type" value="novel">
                    <span class="ai-type-name">小说模式</span>
                    <span class="ai-type-desc">400字以上，纯硬核</span>
                </label>
            </div>
        </div>

        <div class="upload-area" id="upload-area">
            <div class="upload-inner">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="64" height="64">
                    <path d="M11 14.9861C11 15.5384 11.4477 15.9861 12 15.9861C12.5523 15.9861 13 15.5384 13 14.9861V7.82831L16.2428 11.0711L17.657 9.65685L12.0001 4L6.34326 9.65685L7.75748 11.0711L11 7.82854V14.9861Z" fill="currentColor"/>
                    <path d="M4 14H6V18H18V14H20V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V14Z" fill="currentColor"/>
                </svg>
                <p>拖拽图片到这里或<span class="upload-btn">点击上传</span></p>
                <input type="file" id="file-input" accept="image/*" hidden>
            </div>
        </div>

        <div class="preview-container hidden" id="preview-container">
             <div class="image-preview-container">
                <img id="preview-image" src="" alt="待分析的图片">
            </div>
            <div class="preview-actions">
                <button id="start-analysis-btn" class="btn">🚀 获取AI评分</button>
                <button id="change-image-btn" class="btn btn-secondary">🔁 换张图</button>
            </div>
        </div>

        <div class="result-container hidden" id="result-container">
            <div class="image-preview-container-result" id="image-preview-container-result">
                <img id="image-preview" src="" alt="上传的图片">
                <div class="image-overlay">
                    <p>点击或拖拽以替换图片</p>
                </div>
            </div>
            <div id="loading" class="loading hidden">
                <p>AI正在分析中...</p>
            </div>
            <div id="result" class="result hidden">
                <div class="verdict-container">
                    <h2 id="verdict">评分：</h2>
                    <div id="verdict-icon"></div>
                </div>
                <p id="explanation"></p>
                <div class="result-actions">
                    <button id="try-again" class="btn">🔁 再试一次</button>
                </div>
            </div>
        </div>
        <button class="btn view-saved-btn" id="view-saved">📁 查看保存的结果</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 状态管理 ---
            let selectedImageDataUrl = null;
            let analysisCount = parseInt(localStorage.getItem('analysisCount') || '0');

            // --- DOM 元素 ---
            const elements = {
                analysisCount: document.getElementById('analysis-count'),
                uploadArea: document.getElementById('upload-area'),
                fileInput: document.getElementById('file-input'),
                previewContainer: document.getElementById('preview-container'),
                previewImage: document.getElementById('preview-image'),
                startAnalysisBtn: document.getElementById('start-analysis-btn'),
                changeImageBtn: document.getElementById('change-image-btn'),
                resultContainer: document.getElementById('result-container'),
                imagePreview: document.getElementById('image-preview'),
                loading: document.getElementById('loading'),
                result: document.getElementById('result'),
                verdict: document.getElementById('verdict'),
                verdictIcon: document.getElementById('verdict-icon'),
                explanation: document.getElementById('explanation'),
                tryAgainBtn: document.getElementById('try-again'),
                closeDisclaimerBtn: document.getElementById('close-disclaimer'),
                closeAnnouncementBtn: document.getElementById('close-announcement'),
                viewSavedBtn: document.getElementById('view-saved')
            };

            // --- 工具函数 ---
            const updateStats = () => {
                elements.analysisCount.textContent = analysisCount;
                localStorage.setItem('analysisCount', analysisCount.toString());
            };
            
            const getRatingLabel = (rating) => {
                if (rating <= 2) return '纯属答辩';
                if (rating <= 4) return '勉强能冲';
                if (rating <= 6) return '有点意思';
                if (rating <= 8) return '嗯了';
                return '直接开导';
            };

            // --- API 调用 ---
            async function analyzeImage(imageDataUrl, aiType) {
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ imageDataUrl, aiType })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.details || 'API 请求失败');
                    }
                    return response.json();
                } catch (error) {
                    console.error("API 调用失败:", error);
                    throw error;
                }
            }

            // --- UI 控制 ---
            const showPreview = (url) => {
                elements.previewImage.src = url;
                elements.uploadArea.classList.add('hidden');
                elements.previewContainer.classList.remove('hidden');
                elements.resultContainer.classList.add('hidden');
            };

            const showLoading = (url) => {
                elements.imagePreview.src = url;
                elements.uploadArea.classList.add('hidden');
                elements.previewContainer.classList.add('hidden');
                elements.resultContainer.classList.remove('hidden');
                elements.loading.classList.remove('hidden');
                elements.result.classList.add('hidden');
            };

            const displayResult = ({ rating, verdict, explanation }) => {
                elements.loading.classList.add('hidden');
                elements.result.classList.remove('hidden');
                elements.verdict.textContent = `${getRatingLabel(rating)} (${rating}/10)`;
                elements.verdictIcon.textContent = verdict === 'SMASH' ? 'SMASH!!' : 'PASS';
                elements.explanation.textContent = explanation;
                elements.result.className = `result ${verdict.toLowerCase()}`;
                analysisCount++;
                updateStats();
            };

            const displayError = (message) => {
                elements.loading.classList.add('hidden');
                elements.result.classList.remove('hidden');
                elements.verdict.textContent = '错误!';
                elements.verdictIcon.textContent = 'ERROR';
                elements.explanation.textContent = message;
                elements.result.className = 'result';
            };

            const resetToUpload = () => {
                elements.previewContainer.classList.add('hidden');
                elements.resultContainer.classList.add('hidden');
                elements.uploadArea.classList.remove('hidden');
                elements.fileInput.value = '';
                selectedImageDataUrl = null;
            };

            // --- 事件处理 ---
            const handleFileSelect = () => {
                if (!elements.fileInput.files.length) return;
                const file = elements.fileInput.files[0];
                if (!file.type.startsWith('image/')) return alert('请选择图片文件');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageDataUrl = e.target.result;
                    showPreview(selectedImageDataUrl);
                };
                reader.readAsDataURL(file);
            };

            const handleStartAnalysis = async () => {
                if (!selectedImageDataUrl) return;
                showLoading(selectedImageDataUrl);
                try {
                    const aiType = document.querySelector('input[name="ai-type"]:checked').value;
                    const response = await analyzeImage(selectedImageDataUrl, aiType);
                    setTimeout(() => displayResult(response), 500);
                } catch (error) {
                    displayError('分析失败，请稍后重试。详情请查看控制台。');
                }
            };

            const handleTryAgain = () => {
                selectedImageDataUrl ? handleStartAnalysis() : resetToUpload();
            };
            
            // --- 初始化 ---
            updateStats();

            // 事件监听
            const dropZones = [elements.uploadArea, elements.previewContainer, document.getElementById('image-preview-container-result')];
            dropZones.forEach(zone => {
                if(zone) {
                    zone.addEventListener('click', () => elements.fileInput.click());
                    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
                    zone.addEventListener('dragleave', (e) => { e.preventDefault(); zone.classList.remove('drag-over'); });
                    zone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        zone.classList.remove('drag-over');
                        if (e.dataTransfer.files.length) {
                            elements.fileInput.files = e.dataTransfer.files;
                            handleFileSelect();
                        }
                    });
                }
            });

            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.startAnalysisBtn.addEventListener('click', handleStartAnalysis);
            elements.changeImageBtn.addEventListener('click', () => elements.fileInput.click());
            elements.tryAgainBtn.addEventListener('click', handleTryAgain);
            elements.closeDisclaimerBtn.addEventListener('click', () => document.getElementById('disclaimer').style.display = 'none');
            elements.closeAnnouncementBtn.addEventListener('click', () => document.getElementById('announcement').style.display = 'none');
            
            // 保存功能提示（因已简化）
            elements.viewSavedBtn.addEventListener('click', () => {
                alert('本地保存功能正在重新设计，敬请期待！');
            });
        });
    </script>
</body>
</html>
